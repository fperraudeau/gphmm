---
title: "Vignette gphmm compute"
author: "Fanny Perraudeau"
date: "04/26/2017"
output: 
    html_document: 
      code_folding: hide
      fig_height: 10
      fig_width: 10
      toc: yes
      toc_float: yes
---

```{r options, echo=FALSE, results="hide",message=FALSE, error=FALSE, include=FALSE, autodep=TRUE}
knitr::opts_chunk$set(fig.align="center", cache=FALSE, error=FALSE, message=FALSE, warning=TRUE)
library(gphmm)
library(jsonlite)
library(Biostrings)
```

Let's see how to compute GPHMM probabilities.


# GPHMM parameters
To compute the GPHMM probabilities, we need GPHMM parameters. We can use the last version of the gphmm parameters in the directory training of the gphmm (default).
```{r}
paramgphmm = fromJSON(findLastJson())
paramgphmm
```

Alternatively, you can use the GPHMM parameters used during the initialization of the GPHMM training
```{r}
paramgphmm = initializeGphmm()
paramgphmm
```

# Compute GPHMM probability
Let's compute the GPHMM probability (actually the log of the GPHMM probability) for the two following sequences   

Query  
```{r}
read = 'ATGCGATGCA'
read
```

Reference sequence
```{r}
ref = 'ATGTACGATGA'
ref
```

GPHMM probability
```{r}
computegphmm(read = read,
             ref = ref,
             parameters = paramgphmm,
             output = "short")
```

You can also look at the long output to look at the path 
```{r}
computegphmm(read = read,
             ref =  ref,
             parameters = paramgphmm,
             output = "long")
```
Note that 'M' means Match or Mismatch.

# Commandline tool
```{bash}
../inst/gphmm.R --help
```

When gphmm compute is used, the two main inputs are  

* a fasta file with the DNA sequences for all the sequences you want to compute the GPHMM probabilities for,  
* a csv file with at least two columns
    - a first column with the name of the queries,  
    - a second column with the name of the reference sequences,
    - optionally, a third column with the quality values of the queries. If not specified, a quality value of 20 is used by default.  
  
The name of the queries and reference sequences in the csv file should have a sequence with the same name in the fasta file. Then, for each row in the csv file, the GPHMM probability is comppute for the corresponding query and reference sequence.



```{r}
n = 100
```

Let's randomly generate `r n` sequences
```{r}
seqs = generateRandomSequences(n = n, meanLen = 100, sdLen = 2,
                               seed = 7373)
writeXStringSet(seqs, 'queries.fasta')
seqs
```

We are going to compute GPHMM for all pairs of sequences. We did not include a column for the quality values, so a quality value of 20 is used.
```{r}
toCompute = data.frame(query = rep(paste0('s', 1:n), n),
                       ref = rep(paste0('s', 1:n), each = n))
write.table(toCompute, 'toCompute.csv')
head(toCompute)
```

So, there are `r nrow(toCompute)` GPHMM probabilities to compute. Let's call the commandline tool gphmm compute
```{bash}
../inst/gphmm.R compute queries.fasta toCompute.csv --verbose
```

The output file is the same as the csv file, but a column has been added for the computed GPHMM probabilities 
```{r}
out = read.table('toCompute_gphmm.csv', stringsAsFactors = F)
head(out)
```